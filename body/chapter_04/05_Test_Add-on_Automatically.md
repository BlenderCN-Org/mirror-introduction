<div id="sect_title_img_4_5"></div>

<div id="sect_title_text"></div>

# アドオンの動作テストを自動化する

<div id="preface"></div>

###### [4-3節](03_Publish_your_Add-on.md)で説明したように、アドオンを公開した後はバグ修正や機能追加を含めてアドオンのサポートをきちんと行うべきです。しかし、アドオンのソースコードを修正するたびにアドオンの動作テストを毎回行うのは面倒です。ましてや、アドオンの規模が大きくなってくるとテストだけで時間の大半を使ってしまい大変です。本節では、コマンドラインからBlenderを実行できることを活用し、アドオンの動作テストを自動化する方法を説明します。


## アドオンの動作テストを自動化する利点

バグ修正や新機能の追加のためにソースコードを修正すると、これまで正しく動作していた既存の機能が正しく動作しなくなるのは、ソフトウェアの開発ではよくあることです。ソースコードを修正しなければこのようなことは起こりませんが、これではソースコードが修正するなと言っているようなものです。そもそもソースコードを修正することでバグが発生してしまうのは、ソースコードの修正の影響が及ぼす範囲をきちんと把握できていないことが原因です。しかし、ソースコードを修正するたびに既存の機能の動作テストを毎回手作業で行っていたのでは、テストに時間をとられてしまい本来のアドオンの開発ができなくなってしまいます。また、Blenderのアドオンを開発する場合は、Blenderのバージョンごとに仕様が変わるAPIについても意識する必要があります。Blenderのバージョンが変わったことで、今まで動作していた機能が正しく動作しなくなるのはよくあることです。そして、新しいバージョンのBlenderがリリースされるたびに、アドオンのすべての機能をテストするのも非常に大変です。

このように、アドオンのテストは非常に手間がかかります。そこで、毎回同じことを繰り返すテストは自動化してしまいましょう。本節では、アドオンのテストを自動化する方法について説明します。


## コマンドラインからBlenderを実行

BlenderはGUIベースのソフトウェアですので、アドオンの機能が正しく動作していることを動作確認するためにはマウスやキーボードを使った操作が必要になります。このため、テストを自動化することが難しいと感じるかもしれません。しかし幸いなことに、BlenderはコマンドラインでPythonスクリプトを実行するモード（CUIモード）が標準で備わっているため、CUIモードを活用してアドオンのテストを自動化することができます。

Blenderをコマンドラインから実行するためには、[1-3節](../chapter_01/03_Prepare_Add-on_development_environment.md)で紹介したように、コンソールウィンドウからBlenderを起動します。しかし、[1-3節](../chapter_01/03_Prepare_Add-on_development_environment.md)で紹介した方法でBlenderを起動すると、BlenderがGUIモードで起動してしまいます。このため、BlenderをCUIモードで起動するためには、次のように ```--background``` オプションを指定して実行します。以降の説明では、Blenderの実行ファイルが置かれているパスが ```/path/blender``` であるとします。

```sh
$ /path/blender --background
```

上記のコマンドを実行すると、BlenderがCUIモードで起動します。しかし、CUIモードでBlenderが起動した直後に終了してしまいます。このため、CUIモードで起動するメリットがわからないかもしれません。CUIモードが強力であるのは、BlenderをGUIで開くことなく、オプション ```--python``` の引数に指定したPythonスクリプトを実行できるところにあります。例えば、レンダリング処理を実行するPythonスクリプトを作成し、高性能なレンダリングを行うサーバでBlenderをCUIで実行することで、ネットワークレンダリングを行うことができます。また、Pythonスクリプトを使って複数の.blendファイルに対して同じ処理を繰り返し行いたい場合にも、コマンドラインから実行することで作業時間を短縮することができます。

ここでは、次に示す簡単なPythonスクリプトを作成し、BlenderのCUIモードで実行してみましょう。スクリプトは、```/path/blender``` が配置されているディレクトリと同じところに、ファイル名 ```run_script_on_cui_mode.py``` として保存します。

```python
a = 50
b = 12
print("a+b=%d" % (a+b) )
```

次に、コンソールウィンドウから次のコマンドを実行します。

```sh
$ /path/blender --background --python run_script_on_cui_mode.py
```

コマンドを実行すると次のメッセージが出力されたあと、Blenderが終了します。

```sh
a+b=62
```

このように、BlenderのCUIモードでPythonスクリプトを実行することができます。本節では、CUIモードでPythonスクリプトが実行できることを利用した、アドオンのテスト自動化について説明します。アドオンの機能をテストするPythonスクリプトを実行することで、マウスやキーボードを用いることなくアドオンのテストを行うことができます。ただし、CUIモードでBlenderを起動しただけではアドオンが有効化されないことに注意が必要です。CUIモードでBlenderを実行し、作成したアドオンを有効化するためには、```--addons``` オプションの引数に有効化したいアドオンのパッケージまたはモジュール名を指定します。例えば、モジュール名が ```addon_test``` であれば、次のコマンドを実行することによりアドオン ```addon_test``` が有効化された状態でBlenderが起動し、スクリプト ```run_script_on_cui_mode.py``` を実行することができます。

```sh
$ /path/blender --background --addons addon_test --python run_script_on_cui_mode.py
```


## アドオンの機能をスクリプトから実行する

[2-2節](../chapter_02/02_Register_Multiple_Operation_Classes.md) で紹介したように、有効化したアドオンの機能は ```bpy.ops.<オペレーションクラスのbl_idname>``` で実行することができます。テストするアドオンを有効化した状態でBlenderを実行し、有効化したアドオンの機能をスクリプトから実行することで、アドオンのテストが行えます。しかし、機能によってはマウスやキーボードが必要なものもあり、スクリプトではテストできないものがあることには注意が必要です。自動化できない機能については、人手で行う必要があります。


## アドオンの動作テストを自動化する方法

CUIモードでスクリプトを実行する方法を説明しましたが、次にアドオンの動作テストを自動化する方法を紹介します。ここでは、GitHubとTravis CIを連携してアドオンをGitHubのリポジトリにコミットした時にテストを行い、アドオンの動作テストを自動化する方法を紹介します。


### GitHubに登録する

[4-3節](03_Publish_your_Add-on.md)で紹介したように、GitHubは数あるソースコード管理サイトの中で最も有名なサイトです。このGitHubの機能の1つに、外部サービスとの連携があります。外部のサービスと連携することにより、例えば更新したソースコードをコミットした時に、コミットの内容が正しいものであるかを外部サービスを利用して確認することができます。GitHubの登録の仕方については、すでに多くの情報がWeb上にあるため、本書では割愛します。以降の説明では、GitHubにすでに登録されているものとして説明します。

GitHubへの登録が完了したら、GitHubにリポジトリを作成します。本節では、```Testing_Blender_Addon_With_Travis_CI``` という名前でリポジトリを作成することを前提として説明します。作成したリポジトリをTravis CIと連携させることで、連携したリポジトリに対してコミットするとテストが自動的に行われるようになります。


### Travis CIに登録する

Travis CIという名前が突然出てきましたが、ここで初めて名前を聞いたという方も多いと思います。Travis CIを説明する前に、CIについて理解しておいた方がよいと思うので、ここで簡単に説明します。

CIとはContinuous Integration（継続的インテグレーション）の略で、ソースコードのビルドやテストをソースコード更新のたびに行うことを指します。ソースコードを修正すると、これまで動作していた機能が動作しなくなるといった問題が生じることがあると前に書きました。このようなことを少しでも避けるため、常にソースコードをテストして問題の発生をできるだけ早く見つけることがCIを行う理由の1つです。CIサービスはCIの実施を支援するサービスで、ソースコードの修正をリポジトリにコミットした時にテストやビルドを自動的に行い、その結果を表示することができます。Travis CIはそのCIサービスの1つです。CIサービスには他にもJenkinsなどがありますが、本書ではGitHubとの連携が簡単なTravis CIを使って説明します。


<div id="webpage"></div>

|Travis CI|
|---|
|https://travis-ci.org/|
|![Travis CI](https://dl.dropboxusercontent.com/s/d5wmzeuhv93nufx/travis_ci.png "Travis CI")|


GitHubと同様、Travis CIへの登録の仕方についてもすでに多くの情報がWeb上にあるため、本書では割愛します。すでにGitHubアカウントを持っているのであれば、特に困ることはないと思います。


### GitHubとTravis CIを連携する

GitHubとTravis CIとの連携は、次の手順で行います。


<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|右上のユーザのアイコンをクリックして表示されるメニューから、*Accounts* をクリックしてアカウント情報を表示します。GitHubで作成したリポジトリの一覧が表示されますので、テスト対象のリポジトリを有効化します。|![GitHubとTravis CIの連携 手順1](https://dl.dropboxusercontent.com/s/zh7p3nmnt9sx6u7/link_to_travis_ci_1.png "GitHubとTravis CIの連携 手順1")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">2</div>|リポジトリ有効化ボタンの隣にある歯車マークをクリックすると、テスト（ビルド）を実行する契機を確認することができます。|![GitHubとTravis CIの連携 手順2](https://dl.dropboxusercontent.com/s/h7vf50tbmyzivi6/link_to_travis_ci_2.png "GitHubとTravis CIの連携 手順2")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">3</div>|デフォルトでは *Build pushes* （プッシュ時にビルド実行）と *Build pull requests* （プルリクエスト時にビルド実行）の2つが有効化されています。|![GitHubとTravis CIの連携 手順3](https://dl.dropboxusercontent.com/s/f836k1u4ab1j9z3/link_to_travis_ci_3.png "GitHubとTravis CIの連携 手順3")|
|---|---|---|


<div id="process_start_end"></div>

---


ここまでの手順を見てもらえばわかると思いますが、GitHubとTravis CIとの連携はクリックを数回行うことで完了する非常に簡単なものとなっています。


### テスト対象のアドオンの作成

Travis CIを使ってテストするために、テスト対象とするアドオンを作成します。ファイル名は ```testee.py``` とします。

[import](../../sample/src/chapter_04/sample_4_5/testee.py)

作成するテスト対象のアドオンには、2つのオペレータクラスが定義されています。```TestOps1``` は何もせずに ```{'FINISHED'}``` を返すオペレーションです。```TestOps2``` はオブジェクト名がCubeであるオブジェクトが存在する場合に ```{'FINISHED'}``` 、存在しない場合に ```{'CANCELLED'}``` を返すオペレーションです。これら2つのオペレーションに対してテストを行います。


### アドオンテスト用スクリプトの作成

アドオンをテストするためのスクリプトを作成します。ファイル名は ```test.py``` とします。

[import](../../sample/src/chapter_04/sample_4_5/test.py)

スクリプトの内容を見ればわかる通り、スクリプトの処理自体は単純で、```testee.py``` で登録したオペレータクラスの ```bl_idname``` を使ってアドオンの機能を呼び出してその結果を確認するだけです。

アドオンの機能を呼び出した後は、戻り値を ```assert``` 文で判定します。```assert``` 文は、第1引数の条件が偽の場合に ```AssertionError``` 例外オブジェクトを発生させます。そして、```except``` 処理の中で ```assert``` 文の第2引数に指定した文字列（第2引数の値は ```e``` に保存されています）を表示した後、```sys.exit(1)``` を呼び出してBlenderが復帰値 ```1``` で終了します。Travis CIはテストのコマンドの結果が ```0``` 以外の場合には、テストが失敗したと判断します。このため、Travis CIはテストが失敗したと判断します。このように、アドオンの機能を実行した時の戻り値が期待したものではなかった場合にBlenderが ```0``` 以外で終了するようなスクリプトを作成することで、アドオンが正常に動作しているかどうかを確認することができます。

Blender実行開始時にはオブジェクト名が *Cube* であるオブジェクトが最初から作られているため、作成したアドオン ```testee.py``` で定義した全てのオペレーションは ```{'FINISHED'}``` で返ります。また、アドオンが正常に読み込まれていれば、```bpy.ops.object.test_ops_1``` や ```bpy.ops.object.test_ops_2``` は ```None``` 以外となるため、全ての ```assert``` 文の第1引数が ```True``` となり、テストが正常に終了します。


### .travis.ymlの作成

Travis CIでテストを実行するためには、```.travis.yml``` ファイルというYAML形式の設定ファイルを作成する必要があります。

[import](../../sample/src/chapter_04/sample_4_5/.travis.yml)

設定ファイルには、次に示す5つの項目について記載します。```.travis.yml``` に記載したコメントも参照してください。なお、コメントで★を記載した部分は、テスト対象とするBlenderのバージョンにより修正が必要な箇所です。

|項目|概要|
|---|---|
|```language```|Travis CIでテストする対象のソースコードのプログラミング言語を指定します。BlenderのアドオンやスクリプトはPythonであるため、pythonを指定します|
|```python```|Pythonのバージョンを指定します。ここには、Blenderが採用するPythonのバージョンを指定します。Blenderが採用するPythonのバージョンを調べる方法については、後ほど紹介します。|
|```before_install```|```install``` 前に実行する処理を、Linuxのコマンドで記述します。Blenderを動作させるために必要なLinuxのパッケージを取得するため、パッケージマネージャの更新とパッケージマネージャからBlenderのインストールを行なっています。パッケージマネージャでインストールしたBlenderは、パッケージマネージャで管理するBlenderのバージョンに依存するため、基本的には利用しません。|
|```install```|```script``` 前（テスト実行前）に実行する処理です。```before_install``` と同様、Linuxのコマンドで記述します。本節のサンプルでは、バージョンが2.75であるBlenderをダウンロードしたあと、アドオンをインストールしています。|
|```script```|テスト実行時に実行する処理を、Linuxのコマンドで記述します。|

Blenderをコマンドラインから実行する方法で記載したように ```script``` には、```--python``` , ```--addons``` と ```--background``` オプションを指定して、アドオン ```testee``` を有効化した上でテストスクリプト ```test.py``` をCUIモードで実行しています。他にも、オーディオを無効化する ```-noaudio``` オプションや初期状態で起動する ```--factory-startup``` オプションを追加しています。```-noaudio``` オプションを指定しないで実行すると、オーディオライブラリ関連のエラーがログに出力されてしまいます。ダウンロードを実行した直後にBlenderを実行するため初期状態での起動となり ```--factory-startup``` は本来不要ですが、念のために指定しています。


<div id="tips">

Blenderのコマンドラインオプションの一覧は、```--help``` オプションを指定して実行することで表示することができます。


#### Blenderが採用しているPythonのバージョンを調べる方法

Blenderが採用するPythonのバージョンを調べるためには、次のスクリプトを *Pythonコンソール* で実行します。実行結果の ```<major>.<minor>.<micro>``` が、Blenderが採用7エルPythonのバージョンとなります。バージョンが2.75であるBlenderは、バージョンが3.4.2であるPythonが使われていることが次のスクリプトからわかりました。

```python
>>> import sys
>>> sys.version_info
sys.version_info(major=3, minor=4, micro=2, releaselevel='final', serial=0)
```


### 作成したアドオンのソースコードをコミット

ここまでで作成したファイルを、以下のようにローカルリポジトリへ以下のように配置します。
なお、事前にGitHub上のリモートリポジトリをローカルに持ってくる(cloneする)必要があります。

```
/    # ローカルリポジトリのディレクトリ
├ .travis.yml   # Travis CIの設定ファイル
├ test.py       # テストスクリプト
└ testee.py     # テスト対象のアドオン
```

上記のファイル一式をGitHub上のリモートリポジトリにコミットします。

```sh
$ cd Testing_Blender_Addon_With_Travis_CI
$ git add .
$ git commit -m "Test add-on with Travis CI"
$ git push origin master
```

リモートリポジトリにコミットすると、Travis CI上で ```before_install``` 、```install``` 、```script``` の順番で実行されます。

### テスト結果を確認する

テストの実行結果は、Travis CIで確認することができます。Travis CI上でテスト結果を確認する方法を次に示します。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|右上のユーザのアイコンから *Accounts* をクリックしてアカウント情報を表示し、リポジトリ名をクリックします。。|![テスト結果の確認 手順1](https://dl.dropboxusercontent.com/s/eowughm4ekq90vv/check_test_result_1.png "テスト結果の確認 手順1")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">2</div>|テストが正常に終了すれば、passedと表示されます。|![テスト結果の確認 手順2](https://dl.dropboxusercontent.com/s/8zpzlg5jz7gtesn/check_test_result_2.png "テスト結果の確認 手順2")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process"></div>

|<div id="box">3</div>|*Job log* から、テストの実行ログを確認することができます。|![テスト結果の確認 手順3](https://dl.dropboxusercontent.com/s/162cqvaq0fqq9e4/check_test_result_3.png "テスト結果の確認 手順3")|
|---|---|---|



<div id="process_start_end"></div>

---


#### テスト失敗時の表示を確認する

テスト失敗時にTravis CIではどのように表示されるか確認します。
テストを失敗させるために、```test.py``` を次のように書き換えます（```test.py``` から変更された箇所はコメントの先頭に ```$``` を記載しています）。オブジェクト名が「Cube」のオブジェクトを削除して、```bpy.ops.object.test_ops_2()``` の戻り値が ```{'CANCELLED'}``` になるようにして、テストが失敗するようにします。

[import](../../sample/src/chapter_04/sample_4_5/test_alt.py)

修正後にアドオンのソースコードをリポジトリにコミットし、テストを実行します。


<div id="sidebyside"></div>

|テストは期待した通り失敗し、Travis CIのテスト結果では左図のように失敗したことが表示されます。|![テスト失敗時の表示確認1](https://dl.dropboxusercontent.com/s/3cfuwl2hkmhnyd0/check_test_failed_result_1.png "テスト失敗時の表示確認1")|
|---|---|

|ログには失敗した原因が表示されています。|![テスト失敗時の表示確認2](https://dl.dropboxusercontent.com/s/ljo7ty7uin68v58/check_test_failed_result_2.png "テスト失敗時の表示確認2")|
|---|---|


## まとめ

GitHubとTravis CIを利用して、アドオンのテストを自動化する方法を紹介しました。すでにGitHubでアドオンを公開している方や、これから公開することを考えている方は、本節で紹介したテストの自動化はアドオンの品質や開発効率の向上に役立つと思います。GitHubにアドオンを公開しない方でも、BlenderをCUIモードで起動してテストスクリプトを実行することでもアドオンをテストすることができることを覚えておきましょう。

本節で紹介したテスト自動化は、修正時に他の機能への影響が見えづらくかつテスト量が多くなりがちな、ソースコードの規模が大きいアドオンに対して効果を発揮します。一方数百行程度のアドオンの場合、テストスクリプトや設定ファイル作成などのテスト自動化の手続きにより、かえって手間がかかってしまう可能性があります。また今後のサポートを考えていないなど、あくまで個人用途で作成したアドオンであれば、テストを行う必要がないかもしれません。作成したアドオンの規模やサポート範囲を踏まえ、アドオンの自動テスト化を行うか判断すると良いと思います。


<div id="point"></div>

### ポイント

<div id="point_item"></div>

* アドオンのテストを自動化することで、ソースコードを修正したことによるバグの発生を早期に発見できる
* *ターミナル* からBlenderを実行する時にオプション ```--background``` を指定することでCUIモードでBlenderを実行することができる
* CUIモードでPythonスクリプトを実行するためには、```--python``` オプションの引数に実行するスクリプト名を指定する
* CUIモードでアドオンを有効化するためには、```--addons``` オプションの引数に有効化したいアドオンのパッケージまたはモジュール名を指定する
* GitHubをTravis CIと連携することで、GitHubのリポジトリにコミットした時に ```.travis.yml``` に記載した内容に従ってビルドやテストを行い、その結果をTravis CI上で確認することができる
